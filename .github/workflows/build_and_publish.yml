name: build-and-publish

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: build-and-publish-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

env:
  PKG_DIR: aur        # Директория с PKGBUILD (AUR, сборка из source)

jobs:
  build-package:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    container: archlinux:base
    outputs:
      ver: ${{ steps.vars.outputs.ver }}
      rel: ${{ steps.vars.outputs.rel }}

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Restore pacman cache
        uses: actions/cache@v4
        with:
          path: /var/cache/pacman/pkg
          key: pacman-${{ runner.os }}-${{ hashFiles('aur/PKGBUILD') }}
          restore-keys: |
            pacman-${{ runner.os }}-

      - name: Prepare pacman keyring
        run: |
          pacman -Syu --noconfirm archlinux-keyring gnupg
          pacman-key --init
          pacman-key --populate archlinux

      - name: Install build tools
        run: pacman -S --noconfirm --needed base-devel git openssh sudo libarchive

      - name: Create unprivileged builder
        run: |
          useradd -m builder
          echo 'builder ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
          mkdir -p /home/builder/.npm
          chown -R builder:builder .
          chown -R builder:builder /home/builder/.npm

      - name: Restore npm cache
        uses: actions/cache@v4
        with:
          path: /home/builder/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('src/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Patch PKGBUILD with current commit sha
        run: |
          cd ${{ env.PKG_DIR }}
          sed -i "s|<COMMIT>|${{ github.sha }}|g" PKGBUILD

      - name: Build package (.pkg.tar.zst)
        run: |
          cd ${{ env.PKG_DIR }}
          sudo -u builder makepkg --syncdeps --clean --cleanbuild --noconfirm --force

      - name: Generate .SRCINFO
        run: |
          cd ${{ env.PKG_DIR }}
          sudo -u builder makepkg --printsrcinfo > .SRCINFO

      - name: Collect version variables
        id: vars
        run: |
          cd ${{ env.PKG_DIR }}
          echo "ver=$(grep '^pkgver=' PKGBUILD | cut -d= -f2)" >> $GITHUB_OUTPUT
          echo "rel=$(grep '^pkgrel=' PKGBUILD | cut -d= -f2)" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-pkg
          path: ${{ env.PKG_DIR }}/*.pkg.tar.zst
          retention-days: 7

      - name: Upload AUR metadata artifact
        uses: actions/upload-artifact@v4
        with:
          name: aur-metadata
          path: |
            ${{ env.PKG_DIR }}/PKGBUILD
            ${{ env.PKG_DIR }}/.SRCINFO
            ${{ env.PKG_DIR }}/perplexity.desktop
            ${{ env.PKG_DIR }}/perplexity.png
            ${{ env.PKG_DIR }}/launcher.sh
            ${{ env.PKG_DIR }}/default.conf
            ${{ env.PKG_DIR }}/perplexity.install
          retention-days: 7

  publish-release:
    runs-on: ubuntu-latest
    needs: build-package

    steps:
      - name: Download package artifact
        uses: actions/download-artifact@v4
        with:
          name: arch-pkg
          path: dist

      - name: Create GitHub release with package
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.build-package.outputs.ver }}-${{ needs.build-package.outputs.rel }}
          name: Perplexity v${{ needs.build-package.outputs.ver }}-${{ needs.build-package.outputs.rel }}
          draft: false
          prerelease: false
          files: dist/*.pkg.tar.zst
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  push-aur:
    runs-on: ubuntu-latest
    needs: build-package

    steps:
      - name: Download AUR metadata artifact
        uses: actions/download-artifact@v4
        with:
          name: aur-metadata
          path: aur_out

      - name: Setup SSH for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -t ed25519,rsa aur.archlinux.org > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          cat > ~/.ssh/config <<'EOF'
          Host aur.archlinux.org
            HostName aur.archlinux.org
            User aur
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking yes
            UserKnownHostsFile ~/.ssh/known_hosts
          EOF

      - name: Clone AUR repository
        run: |
          rm -rf aur_repo
          git clone ssh://aur@aur.archlinux.org/perplexity.git aur_repo

      - name: Push PKGBUILD to AUR
        run: |
          set -euo pipefail
          cd aur_repo
          cp ../aur_out/PKGBUILD .
          cp ../aur_out/.SRCINFO .
          # Copy auxiliary source files referenced by PKGBUILD
          cp ../aur_out/perplexity.desktop .
          cp ../aur_out/perplexity.png .
          cp ../aur_out/launcher.sh .
          cp ../aur_out/default.conf .
          # Install script for desktop database & mime registration
          if [ -f ../aur_out/perplexity.install ]; then
            cp ../aur_out/perplexity.install .
          fi
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          git add PKGBUILD .SRCINFO perplexity.desktop perplexity.png launcher.sh default.conf
          if [ -f perplexity.install ]; then
            git add perplexity.install
          fi

          if git diff --cached --quiet; then
            echo "No AUR metadata changes to push"
            exit 0
          fi

          git commit -m "Update to v${{ needs.build-package.outputs.ver }}-${{ needs.build-package.outputs.rel }} (sha ${{ github.sha }})"
          git push origin master || git push origin main
