name: Manual Artifact Cleanup

on:
  workflow_dispatch:

jobs:
  emergency-cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Emergency artifact cleanup
        uses: actions/github-script@v7
        with:
          script: |
            console.log('🚨 Starting emergency artifact cleanup...');
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            console.log(`Found ${artifacts.data.artifacts.length} total artifacts`);
            
            // Delete all artifacts except the 2 most recent
            const sortedArtifacts = artifacts.data.artifacts
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(2); // Keep only 2 most recent
            
            console.log(`Will delete ${sortedArtifacts.length} artifacts`);
            
            let deletedCount = 0;
            let failedCount = 0;
            
            for (const artifact of sortedArtifacts) {
              console.log(`Deleting: ${artifact.name} (${artifact.size_in_bytes} bytes, created: ${artifact.created_at})`);
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                deletedCount++;
                console.log(`✅ Deleted: ${artifact.name}`);
              } catch (error) {
                failedCount++;
                console.log(`❌ Failed to delete ${artifact.name}: ${error.message}`);
              }
            }
            
            console.log(`\n📊 Cleanup Summary:`);
            console.log(`✅ Successfully deleted: ${deletedCount} artifacts`);
            console.log(`❌ Failed to delete: ${failedCount} artifacts`);
            console.log(`📦 Remaining artifacts: 2 (most recent)`);
            console.log(`🎉 Emergency cleanup completed!`);
