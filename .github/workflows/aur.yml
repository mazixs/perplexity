name: Build, Publish Binary, and Update AUR

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    container:
      image: archlinux:base
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          fetch-depth: 0

      - name: Set up environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git bsdtar

      - name: Build binary package
        run: |
          cd aur
          makepkg --clean --syncdeps --noconfirm

      - name: Get built package name
        id: pkgfile
        run: |
          cd aur
          PKGFILE=$(ls *.pkg.tar.zst | head -n1)
          echo "PKGFILE=$PKGFILE" >> $GITHUB_ENV

      - name: Upload binary to GitHub Release
        uses: softprops/action-gh-release@v2.3.2
        with:
          tag_name: binary-${{ github.sha }}
          name: Binary Release ${{ github.sha }}
          files: aur/${{ env.PKGFILE }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update PKGBUILD and .SRCINFO for AUR
        run: |
          cd aur
          # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–µ—Ä—Å–∏—é –∏ —Ä–µ–ª–∏–∑ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
          PKGNAME=$(basename ${{ env.PKGFILE }})
          REGEX='perplexity-([0-9.]+)-([0-9]+)-x86_64.pkg.tar.zst'
          if [[ $PKGNAME =~ $REGEX ]]; then
            PKGVER="${BASH_REMATCH[1]}"
            PKGREL="${BASH_REMATCH[2]}"
          else
            echo "–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –≤–µ—Ä—Å–∏—é –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞: $PKGNAME"
            exit 1
          fi
          # –û–±–Ω–æ–≤–ª—è–µ–º PKGBUILD
          sed -i "s/pkgver=.*/pkgver=${PKGVER}/" PKGBUILD
          sed -i "s/pkgrel=.*/pkgrel=${PKGREL}/" PKGBUILD
          sed -i "|source=.*|source=(\"${PKGNAME}::https://github.com/mazixs/perplexity/releases/download/binary-${{ github.sha }}/${PKGNAME}\")|" PKGBUILD
          echo "sha256sums=('SKIP')" > tmp_sha && awk '/^sha256sums=/{flag=1;next}/^$/{flag=0} !flag{print}' PKGBUILD > tmp && cat tmp_sha tmp > PKGBUILD && rm tmp_sha tmp
          makepkg --printsrcinfo > .SRCINFO

      - name: Push to AUR
        uses: KSXGitHub/github-actions-deploy-aur@v4.1.1
        with:
          pkgname: perplexity
          pkgbuild: aur/PKGBUILD
          assets: |
            aur/.SRCINFO
          commit_username: ${{ secrets.AUR_USERNAME }}
          commit_email: ${{ secrets.AUR_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to binary ${{ env.PKGFILE }}"

      - name: Success notification
        if: success()
        run: |
          echo "üéâ Successfully published ${{ env.PKGFILE }} to GitHub Releases and updated AUR!"
          echo "üì¶ Package: perplexity"
          echo "üîó AUR URL: https://aur.archlinux.org/packages/perplexity"
          echo "‚è∞ Published at: $(date)" 