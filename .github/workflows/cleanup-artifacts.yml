name: Cleanup Artifacts

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  cleanup:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Delete old artifacts
        uses: actions/github-script@v8
        with:
          script: |
            const artifacts = await github.paginate(github.rest.actions.listArtifactsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            console.log(`Found ${artifacts.length} total artifacts`);
            
            // Delete artifacts older than 7 days
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 7);
            
            const oldArtifacts = artifacts
              .filter(artifact => new Date(artifact.created_at) < cutoffDate);
            
            console.log(`Found ${oldArtifacts.length} artifacts older than 7 days`);
            
            for (const artifact of oldArtifacts) {
              console.log(`Deleting artifact: ${artifact.name} (created: ${artifact.created_at})`);
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                console.log(`‚úÖ Deleted: ${artifact.name}`);
              } catch (error) {
                console.log(`‚ùå Failed to delete ${artifact.name}: ${error.message}`);
              }
            }
            
            // Also keep only the 5 most recent build artifacts from this workflow
            const archPkgArtifacts = artifacts
              .filter(artifact => artifact.name === 'arch-pkg')
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
              .slice(5); // Keep only 5 most recent
            
            console.log(`Found ${archPkgArtifacts.length} old arch-pkg artifacts to delete`);
            
            for (const artifact of archPkgArtifacts) {
              console.log(`Deleting old arch-pkg artifact: ${artifact.name}`);
              try {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                console.log(`‚úÖ Deleted: ${artifact.name}`);
              } catch (error) {
                console.log(`‚ùå Failed to delete ${artifact.name}: ${error.message}`);
              }
            }

      - name: Summary
        run: |
          echo "üßπ Artifact cleanup completed"
          echo "üìÖ Cleanup date: $(date)"
          echo "‚ÑπÔ∏è  Artifacts older than 7 days have been removed"
          echo "‚ÑπÔ∏è  Only 5 most recent arch-pkg artifacts are kept"