# Maintainer: mazix <mazix@bk.ru>
pkgname=perplexity
pkgver=1.1.3
pkgrel=1
pkgdesc="Native Perplexity AI client for Linux (Electron wrapper)"
arch=('x86_64')
license=('Apache 2.0')
depends=('electron')
makedepends=('nodejs' 'npm')

# Sources: meta files (archive is created in CI/CD or copied locally)
source=(
  "default.conf"
  "launcher.sh"
  "perplexity.desktop"
  "perplexity.png"
  "perplexity-${pkgver}.tar.gz::https://github.com/mazixs/perplexity/archive/refs/tags/v${pkgver}.tar.gz"
)

# sha256sums for meta files (must match the order in source)
sha256sums=(
  '60d97b5180af59d239b4adcf20847138686f2a79467cac956c4247d754897760'  # default.conf
  '147da994cc8af1f0557da848155d71774ceb5b09e6ef74dfdbc8695af2147bb3'  # launcher.sh
  'cc0ccc05588907474681a197fd658135625426b0f7de6b5006e5ce06fc0257fd'  # perplexity.desktop
  '36ee4908a30561ee36454cc2319dbb636d6b0091c8ab46bc440ba25ce47a746c'  # perplexity.png
  'SKIP' # GitHub релизный архив, хеш обновлять вручную при необходимости
)

prepare() {
  cd "$srcdir"
  tar xzf "perplexity-${pkgver}.tar.gz"
  cd "perplexity-${pkgver}"
  npm install --production --no-optional
}

build() {
  # No additional build steps
  :
}

package() {
  # Copy all source code and node_modules
  install -d "${pkgdir}/usr/lib/${pkgname}"
  cp -r "${srcdir}/perplexity-${pkgver}/." "${pkgdir}/usr/lib/${pkgname}/"

  # Launcher script
  install -Dm755 "${srcdir}/launcher.sh" \
    "${pkgdir}/usr/bin/${pkgname}"

  # .desktop file
  install -Dm644 "${srcdir}/perplexity.desktop" \
    "${pkgdir}/usr/share/applications/${pkgname}.desktop"

  # Icon
  install -Dm644 "${srcdir}/perplexity.png" \
    "${pkgdir}/usr/share/icons/hicolor/512x512/apps/${pkgname}.png"

  # Config
  install -Dm644 "${srcdir}/default.conf" \
    "${pkgdir}/etc/${pkgname}/default.conf"

  # License
  install -Dm644 "${srcdir}/perplexity-${pkgver}/LICENSE" \
    "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
