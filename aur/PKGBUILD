# Maintainer: mazix <mazix@bk.ru>

pkgname=perplexity
pkgver=1.1.3
pkgrel=1
pkgdesc="Native Perplexity AI client for Linux (Electron wrapper)"
arch=('x86_64')
url="https://www.perplexity.ai/"
license=('Apache-2.0')
depends=('electron')

_github_user="mazix"
_github_repo="perplexity"

source=("launcher.sh"
        "perplexity.desktop"
        "perplexity.png"
        "default.conf")

# Контрольные суммы будут обновлены автоматически через updpkgsums
sha256sums=('SKIP' 'SKIP' 'SKIP' 'SKIP')

prepare() {
    # Копируем исходные файлы из локальной папки src
    cp -r "${startdir}/../src"/* "${srcdir}/"
}

build() {
    cd "$srcdir"
    
    # Если есть package.json, можно установить зависимости
    if [ -f "package.json" ]; then
        echo "Installing npm dependencies..."
        npm install --production
    fi
}

package() {
    cd "$srcdir"
    
    # Устанавливаем основные файлы приложения
    install -d "$pkgdir/usr/lib/$pkgname"
    
    # Копируем все файлы приложения, исключая ненужные
    find . -type f \
        ! -path "./aur/*" \
        ! -path "./.git*" \
        ! -path "./node_modules/.cache/*" \
        ! -name "*.md" \
        ! -name ".gitignore" \
        -exec install -Dm644 {} "$pkgdir/usr/lib/$pkgname/{}" \;
    
    # Устанавливаем launcher из локального файла
    install -Dm755 "$srcdir/launcher.sh" "$pkgdir/usr/bin/$pkgname"
    
    # Устанавливаем default.conf
    install -Dm644 "$srcdir/default.conf" "$pkgdir/usr/lib/$pkgname/default.conf"
    
    # Устанавливаем desktop entry из локального файла
    install -Dm644 "$srcdir/perplexity.desktop" "$pkgdir/usr/share/applications/$pkgname.desktop"
    
    # Устанавливаем иконку из локального файла
    install -Dm644 "$srcdir/perplexity.png" "$pkgdir/usr/share/icons/hicolor/512x512/apps/$pkgname.png"
    
    # Устанавливаем лицензию
    if [ -f "LICENSE" ]; then
        install -Dm644 "LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"
    fi
}