# Maintainer: mazix <mazix@bk.ru>
pkgname=perplexity
pkgver=1.1.3
pkgrel=1
pkgdesc="Native Perplexity AI client for Linux (Electron wrapper)"
arch=('x86_64')
url="https://github.com/mazix/perplexity"
license=('Apache 2.0')
depends=('electron')
makedepends=('npm')

# These files are expected to be in the same directory as the PKGBUILD
source=("launcher.sh"
        "perplexity.desktop"
        "perplexity.png"
        "default.conf")

sha256sums=('e407cdc386b008805b5b458135623b4373a6e166dca02fc200514d34d28d712c'
            '61e38f97079451a9a59125232fac460ee38d9c478c893cbf7fd2d6afbd61c9fd'
            '36ee4908a30561ee36454cc2319dbb636d6b0091c8ab46bc440ba25ce47a746c'
            'd3c83b2c03ac67e3bd45601004da2a1d4020e2d5540ca6b2887835e077edfecd')

prepare() {
    # Copy source files from the repository root
    mkdir -p "${srcdir}/perplexity-${pkgver}"
    
    # Try different possible paths to find the src directory
    SRC_PATH=""
    if [ -d "${startdir}/../src" ]; then
        SRC_PATH="${startdir}/../src"
    elif [ -d "${startdir}/../../src" ]; then
        SRC_PATH="${startdir}/../../src"
    elif [ -d "$(dirname "${startdir}")/src" ]; then
        SRC_PATH="$(dirname "${startdir}")/src"
    elif [ -d "$(pwd)/../src" ]; then
        SRC_PATH="$(pwd)/../src"
    fi
    
    if [ -n "${SRC_PATH}" ] && [ -d "${SRC_PATH}" ]; then
        echo "Found src directory at: ${SRC_PATH}"
        # Avoid copying directory into itself by checking if target already exists
        if [ "${SRC_PATH}" != "${srcdir}/perplexity-${pkgver}" ]; then
            cp -r "${SRC_PATH}/"* "${srcdir}/perplexity-${pkgver}/"
        else
            echo "Error: Source and target directories are the same"
            exit 1
        fi
    else
        echo "Error: Cannot find src directory"
        echo "Checked paths:"
        echo "  ${startdir}/../src"
        echo "  ${startdir}/../../src"
        echo "  $(dirname "${startdir}")/src"
        echo "  $(pwd)/../src"
        exit 1
    fi
    
    cd "${srcdir}/perplexity-${pkgver}"
    npm install --production
}

build() {
    # No build steps needed, npm install is now in prepare()
    :
}

package() {
    # Install application files
    install -d "${pkgdir}/usr/lib/${pkgname}"
    cp -r "${srcdir}/perplexity-${pkgver}/." "${pkgdir}/usr/lib/${pkgname}/"

    # Install launcher script
    install -Dm755 "${srcdir}/launcher.sh" "${pkgdir}/usr/bin/${pkgname}"

    # Install desktop entry
    install -Dm644 "${srcdir}/perplexity.desktop" "${pkgdir}/usr/share/applications/${pkgname}.desktop"

    # Install icon
    install -Dm644 "${srcdir}/perplexity.png" "${pkgdir}/usr/share/icons/hicolor/512x512/apps/${pkgname}.png"

    # Install config file
    install -Dm644 "${srcdir}/default.conf" "${pkgdir}/etc/${pkgname}/default.conf"

    # Install license
    install -Dm644 "${srcdir}/perplexity-${pkgver}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
