# Maintainer: mazix <mazix@bk.ru>
pkgname=perplexity
pkgver=1.1.3
pkgrel=1
pkgdesc="Native Perplexity AI client for Linux (Electron wrapper)"
arch=('x86_64')
url="https://github.com/mazix/perplexity"
license=('Apache 2.0')
depends=('electron')
makedepends=('npm' 'nodejs')

# These files are expected to be in the same directory as the PKGBUILD
source=("launcher.sh"
        "perplexity.desktop"
        "perplexity.png"
        "default.conf")

sha256sums=('e407cdc386b008805b5b458135623b4373a6e166dca02fc200514d34d28d712c'
            '61e38f97079451a9a59125232fac460ee38d9c478c893cbf7fd2d6afbd61c9fd'
            '36ee4908a30561ee36454cc2319dbb636d6b0091c8ab46bc440ba25ce47a746c'
            'd3c83b2c03ac67e3bd45601004da2a1d4020e2d5540ca6b2887835e077edfecd')

prepare() {
    # Copy source files from the repository root
    mkdir -p "${srcdir}/perplexity-${pkgver}"
    
    # Try different possible paths to find the src directory
    SRC_PATH=""
    if [ -d "${startdir}/../src" ]; then
        SRC_PATH="$(realpath "${startdir}/../src")"
    elif [ -d "${startdir}/../../src" ]; then
        SRC_PATH="$(realpath "${startdir}/../../src")"
    elif [ -d "$(dirname "${startdir}")/src" ]; then
        SRC_PATH="$(realpath "$(dirname "${startdir}")/src")"
    elif [ -d "$(pwd)/../src" ]; then
        SRC_PATH="$(realpath "$(pwd)/../src")"
    fi
    
    if [ -n "${SRC_PATH}" ] && [ -d "${SRC_PATH}" ]; then
        echo "Found src directory at: ${SRC_PATH}"
        TARGET_PATH="$(realpath "${srcdir}/perplexity-${pkgver}")"
        echo "Target directory: ${TARGET_PATH}"
        
        # Check if there's already a perplexity-${pkgver} directory in src
        if [ -d "${SRC_PATH}/perplexity-${pkgver}" ]; then
            echo "Found existing perplexity-${pkgver} directory in src, copying its contents"
            # Check if directory has any content (including hidden files)
            if [ "$(ls -A "${SRC_PATH}/perplexity-${pkgver}" 2>/dev/null)" ]; then
                # Copy all contents including hidden files
                cp -r "${SRC_PATH}/perplexity-${pkgver}/".* "${TARGET_PATH}/" 2>/dev/null || true
                cp -r "${SRC_PATH}/perplexity-${pkgver}/"* "${TARGET_PATH}/" 2>/dev/null || true
            else
                echo "Warning: perplexity-${pkgver} directory is empty, copying all src contents instead"
                # Copy files one by one to avoid directory conflicts
                for item in "${SRC_PATH}/"*; do
                    if [ -e "$item" ] && [ "$(basename "$item")" != "perplexity-${pkgver}" ]; then
                        cp -r "$item" "${TARGET_PATH}/"
                    fi
                done
            fi
        else
            echo "Copying all src contents to target directory"
            # Avoid copying directory into itself by checking resolved paths
            if [ "${SRC_PATH}" != "${TARGET_PATH}" ]; then
                # Copy files one by one to avoid directory conflicts
                for item in "${SRC_PATH}/"*; do
                    if [ -e "$item" ]; then
                        cp -r "$item" "${TARGET_PATH}/"
                    fi
                done
            else
                echo "Error: Source and target directories are the same"
                echo "Source: ${SRC_PATH}"
                echo "Target: ${TARGET_PATH}"
                exit 1
            fi
        fi
    else
        echo "Error: Cannot find src directory"
        echo "Checked paths:"
        echo "  ${startdir}/../src"
        echo "  ${startdir}/../../src"
        echo "  $(dirname "${startdir}")/src"
        echo "  $(pwd)/../src"
        exit 1
    fi
    
    cd "${srcdir}/perplexity-${pkgver}"
    npm install --production
}

build() {
    # No build steps needed, npm install is now in prepare()
    :
}

package() {
    # Install application files
    install -d "${pkgdir}/usr/lib/${pkgname}"
    cp -r "${srcdir}/perplexity-${pkgver}/." "${pkgdir}/usr/lib/${pkgname}/"

    # Install launcher script
    install -Dm755 "${srcdir}/launcher.sh" "${pkgdir}/usr/bin/${pkgname}"

    # Install desktop entry
    install -Dm644 "${srcdir}/perplexity.desktop" "${pkgdir}/usr/share/applications/${pkgname}.desktop"

    # Install icon
    install -Dm644 "${srcdir}/perplexity.png" "${pkgdir}/usr/share/icons/hicolor/512x512/apps/${pkgname}.png"

    # Install config file
    install -Dm644 "${srcdir}/default.conf" "${pkgdir}/etc/${pkgname}/default.conf"

    # Install license
    install -Dm644 "${srcdir}/perplexity-${pkgver}/LICENSE" "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
