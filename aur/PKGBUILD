# Maintainer: mazix <mazix@bk.ru>
pkgname=perplexity
pkgver=1.1.3
pkgrel=1
pkgdesc="Native Perplexity AI client for Linux (Electron wrapper)"
arch=('x86_64')
license=('Apache 2.0')
depends=('electron')
makedepends=('nodejs' 'npm')

# Источники: локальный tarball с исходниками + мета-файлы
source=(
  "perplexity-${pkgver}.tar.gz"
  "launcher.sh"
  "perplexity.desktop"
  "perplexity.png"
  "default.conf"
)

# sha256sum'ы для desktop/png/conf оставляем прежними,
# для tarball временно ставим SKIP (пересобрать .SRCINFO после первого коммита)
sha256sums=(
  'SKIP'
  'cc0ccc05588907474681a197fd658135625426b0f7de6b5006e5ce06fc0257fd'  # launcher.sh
  '36ee4908a30561ee36454cc2319dbb636d6b0091c8ab46bc440ba25ce47a746c'  # perplexity.desktop
  '0926f58bd0adad27d8cda90feb401cf83350b6d37098d481178bb211cb34e95c'  # perplexity.png
  '73a2a82540005d5c856efba8b01c04aff2f6a42bf890164e37da57691e662d2b'  # default.conf
)

prepare() {
  cd "$srcdir"
  # Распаковываем весь ваш src/* в папку perplexity-1.1.3
  mkdir -p "perplexity-${pkgver}"
  tar xzf "perplexity-${pkgver}.tar.gz" -C "perplexity-${pkgver}"
  cd "perplexity-${pkgver}"

  # Устанавливаем только runtime-зависимости
  npm install --production --no-optional
}

build() {
  # Нет дополнительных build-шагов
  :
}

package() {
  # Копируем весь исходный код и node_modules
  install -d "${pkgdir}/usr/lib/${pkgname}"
  cp -r "${srcdir}/perplexity-${pkgver}/." "${pkgdir}/usr/lib/${pkgname}/"

  # Скрипт запуска
  install -Dm755 "${srcdir}/launcher.sh" \
    "${pkgdir}/usr/bin/${pkgname}"

  # .desktop
  install -Dm644 "${srcdir}/perplexity.desktop" \
    "${pkgdir}/usr/share/applications/${pkgname}.desktop"

  # Иконка
  install -Dm644 "${srcdir}/perplexity.png" \
    "${pkgdir}/usr/share/icons/hicolor/512x512/apps/${pkgname}.png"

  # Конфиг
  install -Dm644 "${srcdir}/default.conf" \
    "${pkgdir}/etc/${pkgname}/default.conf"

  # Лицензия
  install -Dm644 "${srcdir}/perplexity-${pkgver}/LICENSE" \
    "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
