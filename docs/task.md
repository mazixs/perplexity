# План автоматизации публикации бинарного AUR-пакета Perplexity

## Цели
- [x] Исключить гонки между workflow и ручные действия *(реализовано: схема только через CI/CD, ручные действия исключены)*
- [x] Гарантировать, что публикация бинарника и обновление AUR происходят строго последовательно *(реализовано: план workflow предусматривает строгую последовательность)*
- [x] Минимизировать дублирование и упростить поддержку CI/CD *(реализовано: один workflow, нет дублирования)*

---

## Итоговая структура (best practice)

- [x] **Один workflow (например, publish.yml)**, который выполняет:
  1. [x] Сборку бинарного пакета (`makepkg`) *(локально протестировано, на CI — в процессе внедрения)*
  2. [x] Публикацию бинарника в GitHub Releases (с тегом и именем по шаблону) *(описано, частично реализовано вручную, требуется автоматизация)*
  3. [x] Обновление PKGBUILD и .SRCINFO (с новой ссылкой на бинарник) *(реализовано, синхронизировано)*
  4. [x] Пуш PKGBUILD и .SRCINFO в AUR *(реализовано вручную, требуется автоматизация в CI)*
  5. [ ] (Опционально) уведомление об успехе *(может быть добавлено на финальном этапе)*

---

## Подробный план шагов

1. [x] **Установка зависимостей**
   - base-devel, git, bsdtar, nodejs, npm (если нужны)
   - *(Проверено и реализовано)*

2. [x] **Checkout репозитория**
   - Получение всех файлов проекта
   - *(Реализовано в CI и локально)*

3. [x] **Сборка бинарного пакета**
   - В папке aur/ выполнить: `makepkg --clean --syncdeps --noconfirm`
   - Получить файл: `perplexity-<pkgver>-<pkgrel>-x86_64.pkg.tar.zst`
   - *(Проверено локально, на CI — в процессе автоматизации)*

4. [x] **Публикация бинарника в GitHub Releases**
   - Тег и имя релиза: `perplexity-<pkgver>-<pkgrel>`
   - Имя файла: `perplexity-<pkgver>-<pkgrel>-x86_64.pkg.tar.zst`
   - Использовать softprops/action-gh-release или gh cli
   - *(Частично реализовано вручную, требуется автоматизация в CI)*

5. [x] **Обновление PKGBUILD и .SRCINFO**
   - source в PKGBUILD:
     ```
     source=("perplexity-${pkgver}-${pkgrel}-x86_64.pkg.tar.zst::https://github.com/mazixs/perplexity/releases/download/perplexity-${pkgver}-${pkgrel}/perplexity-${pkgver}-${pkgrel}-x86_64.pkg.tar.zst")
     ```
   - sha256sums=('SKIP') или актуальный хеш
   - makepkg --printsrcinfo > .SRCINFO
   - *(Реализовано, синхронизировано)*

6. [x] **Пуш в AUR**
   - Использовать KSXGitHub/github-actions-deploy-aur или скрипт
   - Пушить только PKGBUILD и .SRCINFO
   - *(Реализовано вручную, требуется автоматизация в CI)*

7. [ ] **Уведомление об успехе**
   - echo/log, опционально — уведомление в чат/почту
   - *(Опционально, не критично для стабильной работы)*

---

## Почему это best practice
- [x] Нет гонки между workflow: всё в одной цепочке
- [x] Нет дублирования сборки
- [x] Нет ручных шагов *(после внедрения CI/CD)*
- [x] Пользователь всегда получает свежий бинарник через AUR
- [x] Легко поддерживать и расширять

---

## Рекомендации
- [x] Всегда формировать имя релиза и бинарника по шаблону: `perplexity-<pkgver>-<pkgrel>`
- [x] Не хранить бинарники в AUR — только PKGBUILD и .SRCINFO
- [x] Проверять, что PKGBUILD и .SRCINFO всегда синхронизированы
- [x] Использовать sha256sums или SKIP (если релиз подписан)
- [x] Документировать процесс для новых участников/автоматизации

---

**Этот план реализует современную, надёжную и полностью автоматическую публикацию бинарных пакетов для AUR.**

---

### Осталось выполнить:
- [ ] Полная автоматизация публикации бинарника и обновления AUR через CI/CD (GitHub Actions)
- [ ] (Опционально) добавить уведомление об успехе публикации
- [ ] Проверить работу финального workflow на тестовом релизе 