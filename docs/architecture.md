# Архитектура проекта Perplexity Native (Linux)

## Цель
Автоматизировать превращение Windows-версии Perplexity в нативное Electron-приложение для Linux с публикацией в AUR (Arch Linux User Repository).

---

## Основные этапы автоматизации

1. **Скачивание и распаковка Windows-версии Perplexity**
   - Файл скачивается вручную или автоматически (см. scripts/).
   - Распаковка через 7z/innoextract, получение папки resources/app.asar.

2. **Распаковка app.asar**
   - Используется `npx asar extract app.asar app-src`.
   - Содержимое копируется в `src/` для дальнейшей работы.

3. **Интеграция с Electron для Linux**
   - Исходники из `src/` запускаются через Electron.
   - Не требуется Wine, только electron.

4. **Работа с иконками**
   - Иконки извлекаются из исходников, конвертируются в .png.
   - Копируются в `usr/share/icons/hicolor/512x512/apps/perplexity.png`.

5. **Генерация PKGBUILD и публикация**
   - В папке `aur/` хранятся PKGBUILD, launcher.sh, .desktop, иконка, архив исходников.
   - Сборка через `makepkg -si`.

6. **Конфигурирование и переменные**
   - Все переменные и пользовательские флаги задаются через `~/.config/perplexity/perplexity.conf`.
   - При первом запуске создаётся дефолтный конфиг.
   - Управление путями, флагами, режимами (Wayland/X11) реализовано в launcher.sh.

7. **Интеграция с системой**
   - Launcher устанавливается в `/usr/bin/perplexity`.
   - .desktop-файл чистый, вызывает только `perplexity`.
   - Иконка интегрируется в меню приложений.

8. **Обновление**
   - Проверка новой версии и обновление пакета — вручную или через автоматизацию.

---

## Структура проекта

```
project-root/
├── docs/                  # Документация
├── scripts/               # Скрипты автоматизации (опционально)
├── src/                   # Исходники Electron-обёртки (app-src)
├── aur/                   # PKGBUILD, launcher.sh, .desktop, иконка, архив исходников
├── usr/bin/perplexity     # Launcher (копируется из aur/launcher.sh)
├── usr/share/applications/perplexity.desktop # Ярлык
├── usr/share/icons/hicolor/512x512/apps/perplexity.png # Иконка
├── README.md
└── ...
```

---

## Ключевые нюансы и требования

- **Нет необходимости в энтерпрайз-тестах** — проект личный, тесты минимальны.
- **Иконки** — всех размеров, интеграция через .desktop и PKGBUILD.
- **Конфиг** — хранится в `~/.config/perplexity/`, создаётся автоматически.
- **Запуск** — из терминала как `perplexity`, в системе как "Perplexity".
- **Пути установки** — соответствуют стандартам Arch Linux.
- **Обновление** — вручную или через автоматизацию.
- **Вся логика управления переменными и флагами — в launcher.sh**.
- **.desktop-файл не содержит переменных, только вызов launcher**.

---

## Используемые инструменты и технологии
- **Bash** (launcher.sh с поддержкой Wayland/X11)
- **Electron** (системная зависимость)
- **makepkg** (PKGBUILD для Arch Linux)
- **GitHub Actions** (автоматизация CI/CD)
- **Node.js/npm** (управление зависимостями)
- **ToDesktop Runtime** (базовая платформа)

---

## TODO (минимальный базис)
- [x] Структура исходников и автоматизация сборки
- [x] Launcher с поддержкой переменных и конфига
- [x] Чистый .desktop-файл
- [x] Интеграция иконок
- [x] Документация по сборке и публикации
- [x] Автоматизация CI/CD для AUR публикации
- [x] Поддержка Wayland и X11 в launcher
- [x] Исправление критических ошибок сборки
- [ ] Автоматизация скачивания и обновления (опционально)
- [ ] Расширение поддержки других дистрибутивов 

---

## Best practice: безопасное использование временных файлов и директорий (mktemp)

**Почему важно:**
- Ручное создание временных файлов (например, echo data > /tmp/myfile) небезопасно: возможна подмена файла, коллизии, race condition.
- mktemp гарантирует уникальность имени и выставляет безопасные права доступа.
- Это стандарт для всех современных shell-скриптов, CI/CD и автоматизаций.

**Шаблон для Bash-скриптов:**
```sh
# Временный файл
TMPFILE=$(mktemp)
echo "Данные" > "$TMPFILE"
# ... работа ...
rm "$TMPFILE"

# Временная директория
TMPDIR=$(mktemp -d)
# ... работа ...
rm -r "$TMPDIR"
```

**Рекомендация для проекта:**
- Использовать mktemp во всех новых автоматизациях, скриптах, CI/CD, где требуется временное хранение данных.
- Не использовать фиксированные имена файлов/директорий в /tmp.
- В случае доработки launcher.sh, PKGBUILD, CI/CD — применять этот шаблон.