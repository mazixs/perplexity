# Maintainer: mazix <mazix@bk.ru>

pkgname=perplexity
pkgver=1.3.0
pkgrel=4
pkgdesc='Native Perplexity AI client for Linux'
arch=('x86_64')
url='https://github.com/mazixs/perplexity'
license=('Apache 2.0')
depends=('electron' 'desktop-file-utils' 'xdg-utils')
makedepends=('curl' 'wget')
optdepends=('libappindicator-gtk3: for tray icon support')
#conflicts=('')
source=("perplexity.desktop"
        "perplexity.png"
        "launcher.sh"
        "default.conf"
        "perplexity.install")
sha256sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP'
            'SKIP')

install=perplexity.install

prepare() {
    # Try to find a binary package that matches the current pkgver-pkgrel across all releases.
    local api_url="https://api.github.com/repos/mazixs/perplexity/releases"
    
    # Пытаемся найти релиз с точным соответствием тегу v{pkgver}-{pkgrel}
    local tag_pattern="v${pkgver}-${pkgrel}"
    local download_url=$(curl -s "$api_url" \
        | grep -A 10 "\"tag_name\": \"${tag_pattern}\"" \
        | grep "browser_download_url" \
        | grep "perplexity-.*\\.pkg\\.tar\\.zst" \
        | cut -d '"' -f 4 \
        | head -n1)

    # Fallback 1: ищем любой релиз с нужной версией pkgver
    if [ -z "$download_url" ]; then
        echo "Точный тег не найден, ищем по версии ${pkgver}..."
        download_url=$(curl -s "$api_url" \
            | grep -oE "https://[^\"[:space:]]*/perplexity-${pkgver}-[0-9]+-x86_64\\.pkg\\.tar\\.zst" \
            | head -n1)
    fi

    # Fallback 2: используем latest release
    if [ -z "$download_url" ]; then
        echo "Релиз версии ${pkgver} не найден, используем latest..."
        download_url=$(curl -s "https://api.github.com/repos/mazixs/perplexity/releases/latest" \
            | grep "browser_download_url" \
            | grep "pkg.tar.zst" \
            | cut -d '"' -f 4)
    fi

    if [ -z "$download_url" ]; then
        echo "Error: Could not find download URL for release (pkgver=${pkgver}, pkgrel=${pkgrel})"
        exit 1
    fi

    echo "Downloading from: $download_url"
    wget -O "perplexity-latest.pkg.tar.zst" "$download_url"
}

package() {
    # Extract the binary package
    cd "${srcdir}"
    bsdtar -xf "perplexity-latest.pkg.tar.zst"
    
    # Copy extracted files to package directory
    if [ -d "usr" ]; then
        cp -r usr "${pkgdir}/"
    fi
    if [ -d "opt" ]; then
        cp -r opt "${pkgdir}/"
    fi
    if [ -d "etc" ]; then
        cp -r etc "${pkgdir}/"
    fi
    
    # Override configs and additional files from source
    install -Dm644 "perplexity.desktop" "${pkgdir}/usr/share/applications/perplexity.desktop"
    install -Dm644 "perplexity.png" "${pkgdir}/usr/share/pixmaps/perplexity.png"
    install -Dm755 "launcher.sh" "${pkgdir}/usr/bin/perplexity"
    install -Dm644 "default.conf" "${pkgdir}/etc/perplexity/default.conf"
}